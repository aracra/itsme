<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>It's me! v19.16.0</title>
    <link rel="stylesheet" href="style.css?v=19.15.1">
</head>
<body>

<div class="app-container" id="mainContainer">
    
    <div class="dev-panel-container">
        <div class="dev-row">
            <div id="dbStatus" class="db-status">● 연결 중</div>
            <button onclick="toggleDevMenu()" class="btn-dev-toggle">⚙️ Dev</button>
        </div>
        <div id="devMenuExpanded" class="dev-menu-box">
            <button onclick="if(window.initializeTestDB) { initializeTestDB(); }" class="btn-dev-item">🔄 DB 리셋</button>
            <button onclick="if(window.refillTickets) { window.refillTickets(); }" class="btn-dev-item">🎫 티켓 충전</button>
            <button onclick="if(window.addRichTokens) { window.addRichTokens(); }" class="btn-dev-item">💰 돈복사</button>
        </div>
    </div>

    <div id="customConfirmOverlay" class="sheet-overlay">
        <div class="comment-modal">
            <h3 id="customConfirmTitle">알림</h3> 
            <p id="customConfirmMsg" class="modal-msg">...</p>
            <div class="modal-btn-row">
                <button class="btn-action type-gray small" onclick="closeCustomConfirm()">취소</button>
                <button class="btn-action type-purple small" id="btnCustomConfirmAction">확인</button>
            </div>
        </div>
    </div>

    <div id="customAlertOverlay" class="sheet-overlay">
        <div class="comment-modal">
            <h3 id="customAlertTitle">알림</h3>
            <p id="customAlertMsg" class="modal-msg">...</p>
            <div class="modal-btn-row">
                <button class="btn-action type-purple small" id="btnCustomAlertOk">확인</button>
            </div>
        </div>
    </div>
    
    <div id="shoutInputOverlay" class="sheet-overlay">
        <div class="comment-modal">
            <h3>📢 전체 외치기 메시지</h3>
            <p>친구들에게 전달하고 싶은 메시지를 입력해주세요.</p>
            <textarea id="shoutInputText" placeholder="최대 50자 입력" maxlength="50"></textarea>
            <p id="shoutInputPrice" class="modal-msg margin-top-10">가격: 50 💎</p>
            <div class="modal-btn-row">
                <button class="btn-action type-gray small" onclick="closePopup('shoutInputOverlay')">취소</button>
                <button class="btn-action type-purple small" id="btnShoutSubmit">보내기</button>
            </div>
        </div>
    </div>

    <div id="inventoryOverlay" class="sheet-overlay">
        <div class="comment-modal modal-wide">
            <h3 class="margin-bottom-30">🎒 내 가방</h3>
            
            <div class="tab-line-header">
                <div class="tab-line-item active inv-tab" onclick="updateInventoryList('all', this)">전체</div>
                <div class="tab-line-item inv-tab" onclick="updateInventoryList('avatar', this)">아바타</div>
                <div class="tab-line-item inv-tab" onclick="updateInventoryList('effect', this)">효과</div>
            </div>

            <div id="inventoryListArea" class="inventory-list-area"></div>

            <div class="modal-btn-row margin-top-15">
                <button class="btn-action type-purple" onclick="closePopup('inventoryOverlay')" style="width: 100%; margin-bottom: 0;">닫기</button>
            </div>
        </div>
    </div>

    <div id="excludeOverlay" class="sheet-overlay">
        <div class="comment-modal">
            <h3>🚫 모르는 사람 제외</h3>
            <p>누구를 목록에서 제외할까요?<br><span class="warn-text">제외하면 앞으로 투표에 나오지 않습니다.</span></p>
            <div class="exclude-list-box">
                <button id="btnExcludeA" class="btn-action type-gray exclude-item-btn">
                    <span id="txtExcludeA" class="exclude-name">...</span>
                    <span class="exclude-label">제외 🚫</span>
                </button>
                <button id="btnExcludeB" class="btn-action type-gray exclude-item-btn">
                    <span id="txtExcludeB" class="exclude-name">...</span>
                    <span class="exclude-label">제외 🚫</span>
                </button>
            </div>
            <button class="btn-action type-purple" onclick="closePopup('excludeOverlay')">취소</button>
        </div>
    </div>

    <div id="commentOverlay" class="sheet-overlay">
        <div class="comment-modal">
            <h3>💬 한 줄 평</h3>
            <p id="commentTargetName">...</p>
            <textarea id="commentInput" placeholder="이 친구의 어떤 점이 좋았나요? (30자)" maxlength="30"></textarea>
            <div class="modal-btn-row">
                <button class="btn-action type-gray" onclick="closePopup('commentOverlay')">취소</button>
                <button class="btn-action type-purple" onclick="submitComment()">보내기</button>
            </div>
        </div>
    </div>

    <div id="profileMsgOverlay" class="sheet-overlay">
        <div class="comment-modal">
            <h3>✏️ 상태 메시지 변경</h3>
            <p>나를 표현하는 한 마디를 입력해주세요.</p>
            <textarea id="profileMsgInput" placeholder="상태 메시지 (50자)" maxlength="50"></textarea>
            <div class="modal-btn-row">
                <button class="btn-action type-gray" onclick="closePopup('profileMsgOverlay')">취소</button>
                <button class="btn-action type-purple" onclick="submitProfileMsg()">확인</button>
            </div>
        </div>
    </div>

    <div id="screen-login" class="screen active full-center">
        <div class="center-content">
            <div class="emoji-logo">🧐</div>
            <h1>It's me!</h1>
            <p>남들이 보는 진짜 나,<br>3초 만에 확인해보세요.</p>
        </div>
        <div class="login-btn-area">
            <button class="btn-action type-kakao btn-master" onclick="loginWithServer()">카카오로 시작하기</button>
            <button class="btn-action type-gray btn-master" onclick="loginWithServer()">이메일로 시작하기</button>
            <div class="dev-login-area">
                <p>🚧 개발자 테스트</p>
                <div class="dev-login-row">
                    <button class="btn-dev-login type-a" onclick="debugLogin('user_test_a')">🦊 A (나)</button>
                    <button class="btn-dev-login type-b" onclick="debugLogin('user_test_b')">🐰 B (너)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-mbti" class="screen">
        <div class="scroll-body padding-20">
            <div class="margin-top-20"></div>
            <h2>기초 데이터 입력</h2>
            <p>나의 MBTI를 선택해주세요.</p>
            <div class="mbti-grid" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
                <button class="stat-pill" onclick="saveMbtiToServer('ENFP')">ENFP</button><button class="stat-pill" onclick="saveMbtiToServer('ISTJ')">ISTJ</button>
                <button class="stat-pill" onclick="saveMbtiToServer('ENTP')">ENTP</button><button class="stat-pill" onclick="saveMbtiToServer('INFJ')">INFJ</button>
                <button class="stat-pill" onclick="saveMbtiToServer('ISTP')">ISTP</button><button class="stat-pill" onclick="saveMbtiToServer('ISFP')">ISFP</button>
                <button class="stat-pill" onclick="saveMbtiToServer('INFP')">INFP</button><button class="stat-pill" onclick="saveMbtiToServer('INTP')">INTP</button>
                <button class="stat-pill" onclick="saveMbtiToServer('ESTP')">ESTP</button><button class="stat-pill" onclick="saveMbtiToServer('ESFP')">ESFP</button>
                <button class="stat-pill" onclick="saveMbtiToServer('ESTJ')">ESTJ</button><button class="stat-pill" onclick="saveMbtiToServer('ESFJ')">ESFJ</button>
                <button class="stat-pill" onclick="saveMbtiToServer('ENFJ')">ENFJ</button><button class="stat-pill" onclick="saveMbtiToServer('ENTJ')">ENTJ</button>
                <button class="stat-pill" onclick="saveMbtiToServer('INTJ')">INTJ</button><button class="stat-pill" onclick="saveMbtiToServer('ISFJ')">ISFJ</button>
            </div>
            <button class="btn-action type-purple margin-top-20" onclick="goScreen('screen-test-1')">🤔 테스트로 찾기</button>
        </div>
    </div>

    <div id="screen-test-1" class="screen full-center"><div class="padding-20 text-center"><h3>Q1. 불금이다!<br>친구들이 부르면?</h3><button class="btn-action type-gray" onclick="nextTest('E', 'screen-test-2')">오예! 당장 나간다! (E)</button><button class="btn-action type-gray" onclick="nextTest('I', 'screen-test-2')">기 빨려... 집이 최고야. (I)</button></div></div>
    <div id="screen-test-2" class="screen full-center"><div class="padding-20 text-center"><h3>Q2. 멍 때릴 때<br>무슨 생각해?</h3><button class="btn-action type-gray" onclick="nextTest('S', 'screen-test-3')">배고파... 저녁 뭐 먹지? (S)</button><button class="btn-action type-gray" onclick="nextTest('N', 'screen-test-3')">좀비가 나타나면 어떡하지? (N)</button></div></div>
    <div id="screen-test-3" class="screen full-center"><div class="padding-20 text-center"><h3>Q3. 친구가 우울해서<br>화분 샀다고 하면?</h3><button class="btn-action type-gray" onclick="nextTest('T', 'screen-test-4')">무슨 화분 샀어? 얼마야? (T)</BUTTON><button class="btn-action type-gray" onclick="nextTest('F', 'screen-test-4')">헐... 무슨 일 있어? ㅠㅠ (F)</button></div></div>
    <div id="screen-test-4" class="screen full-center"><div class="padding-20 text-center"><h3>Q4. 여행 갈 때<br>계획은?</h3><button class="btn-action type-gray" onclick="finishTest('J')">엑셀 켜고 분 단위 일정표 (J)</button><button class="btn-action type-gray" onclick="finishTest('P')">여권만 챙겨서 출발! (P)</button></div></div>
    
    <div id="screen-nickname" class="screen full-center">
        <div class="padding-20 text-center">
            <h2>반가워요! 👋</h2>
            <p>앱에서 사용할 닉네임을 알려주세요.</p>
            <input type="text" id="inputNickname" placeholder="닉네임 입력 (예: 개발왕)">
            <button class="btn-action type-purple btn-master" onclick="saveNicknameAndNext()">시작하기</button>
        </div>
    </div>
    
    <div id="screen-main" class="screen">
        <div class="sticky-header-group has-tabs">
            <h2 class="main-screen-title">나의 거울</h2>
            
            <div class="avatar-area">
                <div class="avatar-circle">
                    <span id="myAvatar" class="my-profile-icon">👤</span>
                    <div class="avatar-badge" id="myMbtiBadge">#???</div>
                </div>
                
                <div class="avatar-text-group">
                    <div class="profile-header-row">
                        <div id="myNicknameDisplay" class="profile-name">닉네임</div>
                        <div class="header-badge">👑 상위 12% (종합)</div>
                    </div>

                    <div class="msg-bubble">
                        <span id="mainMsg">"상태 메시지"</span>
                        <button onclick="editProfileMsg()" class="btn-edit-in-bubble">✏️</button>
                    </div>
                </div>
            </div>

            <div class="tab-line-header margin-top-20">
                <div class="tab-line-item active" onclick="goSubTab('tab-prism', this)">프리즘</div>
                <div class="tab-line-item" onclick="goSubTab('tab-history', this)">발자취</div>
                <div class="tab-line-item" onclick="goSubTab('tab-trophy', this)">업적</div>
            </div>
        </div>
        
        <div class="scroll-body no-scrollbar">
            <div id="tab-prism" class="sub-content active"><div class="chart-wrapper"><canvas id="myRadarChart"></canvas></div></div>
            <div id="tab-history" class="sub-content"><ul class="list-wrap"></ul></div>
            <div id="tab-trophy" class="sub-content"><div class="achieve-grid"></div></div>
        </div>
    </div>

    <div id="screen-vote" class="screen">
        <div id="voteHeader" class="vote-header sticky-header-group"> 
            <h2 class="main-screen-title">이미지 월드컵</h2>
            <div class="vote-status-row">
                <span class="ticket-badge" id="ticketDisplay">🎫 남은 티켓: 5/5</span>
                <span class="round-badge" id="roundBadge">토너먼트 시작</span>
            </div>
            <h3 id="voteTitle" class="vote-question-title"></h3>
        </div>

        <div class="scroll-body no-scrollbar flex-column-center">
            
            <div id="voteIntro" class="vote-intro-container">
                <div class="emoji-logo">🏆</div>
                <h2 class="main-screen-title">내 픽(Pick)은 누구?</h2>
                <p id="introDesc" class="margin-bottom-30">
                    주제를 선택하고 토너먼트를 시작해보세요!<br>
                    최종 우승자에게는 당신의 마음을 전할 수 있습니다.
                </p>
                
                <div class="start-btn-wrapper">
                    <div id="startBtnBadge" class="floating-badge">
                        <span class="fb-label">남은 티켓</span>
                        <span id="ticketCountNum" class="fb-count">5</span>
                    </div>
                    <button id="startBtn" class="btn-action type-purple btn-master" onclick="realStartGame()">
                        픽 하러 가기
                    </button>
                </div>
            </div>

            <div class="vote-wrapper" id="voteWrapper">
                <div class="vs-container" id="vsContainer">
                    <div class="vs-card" onclick="vote(0)">
                        <div class="vs-avatar" id="avatarA">❓</div>
                        <div class="vs-name" id="nameA">...</div>
                        <div class="vs-desc" id="descA">...</div>
                    </div>
                    
                    <div class="vs-divider-text">VS</div>
                    
                    <div class="vs-card" onclick="vote(1)">
                        <div class="vs-avatar" id="avatarB">❓</div>
                        <div class="vs-name" id="nameB">...</div>
                        <div class="vs-desc" id="descB">...</div>
                    </div>
                </div>
            </div>
            
            <div id="winnerContainer">
                <div class="winner-box">
                    <div class="winner-avatar" id="winnerAvatar">🏆</div> 
                    <div class="winner-text-group">
                        <h2 id="winnerTitle">우승!</h2> 
                        <h1 id="winnerName">...</h1>
                        <p id="winnerText">점수 전달 완료!</p>
                    </div>
                    <div id="winnerActionArea" style="width:100%; margin-top:20px;"></div>
                </div>
            </div>
            
            <button class="btn-simple-text" id="passBtn" onclick="window.openExcludeOption()">
                🚫 모르는 사람이 있어요 (제외하기)
            </button>
        </div>
    </div>
    
    <div id="screen-rank" class="screen">
        <div class="sticky-header-group">
            <div class="rank-header-area">
                <h2 class="main-screen-title">주변미터 랭킹</h2>
                <div id="rankFilterContainer" class="rank-filter-wrapper">
                    <div class="filter-top-row">
                        <div class="ranking-switch-container">
                            <input type="radio" id="tabRank" name="rankView" checked onchange="switchRankView('rank')">
                            <label for="tabRank" class="switch-label">🏆 전체 랭킹</label>

                            <input type="radio" id="tabFandom" name="rankView" onchange="switchRankView('fandom')">
                            <label for="tabFandom" class="switch-label">💖 나의 팬덤</label>
                            
                            <div class="switch-selection"></div>
                        </div>
                    </div>
                    <div class="filter-scroll-row no-scrollbar">
                        <div class="stat-pill" onclick="filterRank(this, 0)">🧠 <span class="pill-text">지성</span></div>
                        <div class="stat-pill" onclick="filterRank(this, 1)">⚡ <span class="pill-text">센스</span></div>
                        <div class="stat-pill" onclick="filterRank(this, 2)">🛡️ <span class="pill-text">멘탈</span></div>
                        <div class="stat-pill" onclick="filterRank(this, 3)">💖 <span class="pill-text">인성</span></div>
                        <div class="stat-pill" onclick="filterRank(this, 4)">🎉 <span class="pill-text">텐션</span></div>
                        <div class="stat-pill" onclick="filterRank(this, 5)">🌀 <span class="pill-text">광기</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="scroll-body no-scrollbar">
            <ul class="list-wrap" id="rankListContainer"></ul>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="sticky-header-group">
            <h2 class="main-screen-title padding-top-20">상점</h2>
            <div class="shop-token-info" style="margin-bottom: 8px;">
                내 보유 토큰: <span id="shopTokenDisplay">0</span> 💎
            </div>
            
            <button class="btn-action type-gray small" onclick="openInventory()" 
                    style="width: auto; padding: 5px 15px; min-height: 36px; font-size: 13px; margin-bottom: 5px; box-shadow:none; border:1px solid #dfe6e9;">
                🎒 구매한 아이템 확인 / 장착
            </button>
        </div>

        <div class="scroll-body no-scrollbar padding-top-50">
            <div class="ranking-switch-container shop-switch">
                <input type="radio" id="shopUtil" name="shopView" checked onchange="filterShop('utility')">
                <label for="shopUtil" class="switch-label">🪄</label>

                <input type="radio" id="shopDeco" name="shopView" onchange="filterShop('deco')">
                <label for="shopDeco" class="switch-label">🎨</label>

                <input type="radio" id="shopSocial" name="shopView" onchange="filterShop('social')">
                <label for="shopSocial" class="switch-label">📢</label>

                <input type="radio" id="shopGacha" name="shopView" onchange="filterShop('gacha')">
                <label for="shopGacha" class="switch-label">🎲</label>
                
                <div class="switch-selection"></div>
            </div>

            <div class="shop-grid"></div>

        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="sticky-header-group">
            <h2 class="main-screen-title">설정</h2>
        </div>
        
        <div class="scroll-body no-scrollbar padding-top-50">
            
            <div class="settings-account-box">
                <span class="acc-label">로그인 정보</span>
                <span class="acc-value" id="settingsAccountDisplay">kakao_guest</span>
            </div>

            <ul class="settings-menu">
                <li class="st-menu-item" onclick="openInventory()">
                    <span>🎒 내 아이템 보관함</span>
                    <span class="text-gray">></span>
                </li>

                <li class="st-menu-item" onclick="shareLink()">
                    <span>💌 친구 초대하기</span>
                    <span class="text-gray">></span>
                </li>

                <li class="st-menu-item"><span>🔔 알림 설정</span><span class="text-gray">></span></li>
                <li class="st-menu-item"><span>📜 이용 약관</span><span class="text-gray">></span></li>
            </ul>
            
            <button class="btn-logout" onclick="logout()">로그아웃</button>
            
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="goTab('screen-main', this)"><span class="nav-icon">🪞</span>거울</div>
        <div class="nav-item" onclick="goTab('screen-vote', this)"><span class="nav-icon">⚖️</span>평가</div>
        <div class="nav-item" onclick="goTab('screen-rank', this)"><span class="nav-icon">🏆</span>랭킹</div>
        <div class="nav-item" onclick="goTab('screen-shop', this)"><span class="nav-icon">🛍️</span>상점</div>
        <div class="nav-item" onclick="goTab('screen-settings', this)"><span class="nav-icon">⚙️</span>설정</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js" defer></script>

<script src="logic.js?v=19.15.1" defer></script>
<script src="ui.js?v=19.15.1" defer></script>
<script src="init_test.js?v=19.15.0" defer></script> 

<script>
    window.addEventListener('DOMContentLoaded', function() {
        if (window.loadDataFromServer) {
            window.loadDataFromServer();
            setTimeout(() => { if(window.initShoutListener) window.initShoutListener(); }, 2000);
        } else {
            console.error("Logic Module Load Failed.");
            document.getElementById('dbStatus').innerText = "● 로드 오류";
            document.getElementById('dbStatus').classList.add('error');
        }
    });
</script>

</body>
</html>