<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>It's me! v9.0 (Final Merge)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app-container" id="mainContainer">
    <div id="dbStatus" class="db-status">● DB OK</div>

    <div id="screen-login" class="screen active">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <div style="font-size: 60px; margin-bottom: 20px;">🧐</div><h1>It's me!</h1><p>남들이 보는 진짜 나,<br>3초 만에 확인해보세요.</p>
        </div>
        <button class="btn btn-kakao" onclick="loginWithServer()">카카오로 시작하기</button>
        <button class="btn btn-outline" onclick="loginWithServer()">이메일로 시작하기</button>
    </div>

    <div id="screen-mbti" class="screen">
        <div style="height: 20px;"></div><h2 style="text-align:center;">기초 데이터 입력</h2>
        <div class="mbti-grid">
            <button class="mbti-btn" onclick="saveMbtiToServer('ENFP')">ENFP</button><button class="mbti-btn" onclick="saveMbtiToServer('ISTJ')">ISTJ</button><button class="mbti-btn" onclick="saveMbtiToServer('ENTP')">ENTP</button><button class="mbti-btn" onclick="saveMbtiToServer('INFJ')">INFJ</button>
            <button class="mbti-btn" onclick="saveMbtiToServer('ISTP')">ISTP</button><button class="mbti-btn" onclick="saveMbtiToServer('ISFP')">ISFP</button><button class="mbti-btn" onclick="saveMbtiToServer('INFP')">INFP</button><button class="mbti-btn" onclick="saveMbtiToServer('INTP')">INTP</button>
            <button class="mbti-btn" onclick="saveMbtiToServer('ESTP')">ESTP</button><button class="mbti-btn" onclick="saveMbtiToServer('ESFP')">ESFP</button><button class="mbti-btn" onclick="saveMbtiToServer('ESTJ')">ESTJ</button><button class="mbti-btn" onclick="saveMbtiToServer('ESFJ')">ESFJ</button>
            <button class="mbti-btn" onclick="saveMbtiToServer('ENFJ')">ENFJ</button><button class="mbti-btn" onclick="saveMbtiToServer('ENTJ')">ENTJ</button><button class="mbti-btn" onclick="saveMbtiToServer('INTJ')">INTJ</button><button class="mbti-btn" onclick="saveMbtiToServer('ISFJ')">ISFJ</button>
        </div>
        <button class="btn btn-primary" onclick="goScreen('screen-test-1')">🤔 잘 모르겠어요 (30초 테스트)</button>
    </div>

    <div id="screen-test-1" class="screen">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h3 style="text-align:center;">Q1. 불금이다!<br>친구들이 부르면?</h3>
            <button class="btn btn-outline" onclick="nextTest('E', 'screen-test-2')">오예! 당장 나간다! (E)</button>
            <button class="btn btn-outline" onclick="nextTest('I', 'screen-test-2')">기 빨려... 집이 최고야. (I)</button>
        </div>
    </div>
    <div id="screen-test-2" class="screen">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h3 style="text-align:center;">Q2. 멍 때릴 때<br>무슨 생각해?</h3>
            <button class="btn btn-outline" onclick="nextTest('S', 'screen-test-3')">배고파... 저녁 뭐 먹지? (S)</button>
            <button class="btn btn-outline" onclick="nextTest('N', 'screen-test-3')">좀비가 나타나면 어떡하지? (N)</button>
        </div>
    </div>
    <div id="screen-test-3" class="screen">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h3 style="text-align:center;">Q3. 친구가 우울해서<br>화분 샀다고 하면?</h3>
            <button class="btn btn-outline" onclick="nextTest('T', 'screen-test-4')">무슨 화분 샀어? 얼마야? (T)</button>
            <button class="btn btn-outline" onclick="nextTest('F', 'screen-test-4')">헐... 무슨 일 있어? ㅠㅠ (F)</button>
        </div>
    </div>
    <div id="screen-test-4" class="screen">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h3 style="text-align:center;">Q4. 여행 갈 때<br>계획은?</h3>
            <button class="btn btn-outline" onclick="finishTest('J')">엑셀 켜고 분 단위 일정표 (J)</button>
            <button class="btn btn-outline" onclick="finishTest('P')">여권만 챙겨서 출발! (P)</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="header-area"><h2 class="header-title">나의 거울</h2><div class="header-badge">👑 상위 12% (종합)</div></div>
        <div class="avatar-area"><div class="avatar-circle"><span id="myAvatar">🦊</span><div class="avatar-badge" id="myMbtiBadge">#???</div></div></div>
        <div class="sub-tab-bar">
            <div class="sub-tab active" onclick="goSubTab('tab-prism', this)">프리즘</div>
            <div class="sub-tab" onclick="goSubTab('tab-history', this)">발자취</div>
            <div class="sub-tab" onclick="goSubTab('tab-trophy', this)">업적</div>
        </div>
        <div id="tab-prism" class="sub-content active">
            <div class="chart-wrapper"><canvas id="myRadarChart"></canvas></div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align:center;">
                <div style="font-size: 12px; color: #636e72; margin-bottom: 5px;">💬 나의 한마디</div>
                <div id="mainMsg" style="font-weight: bold; color: #2d3436; font-size: 14px;">"상태 메시지를 입력해주세요"</div>
            </div>
        </div>
        <div id="tab-history" class="sub-content">
            <ul class="list-wrap"><li class="list-item"><div class="list-icon">📈</div><div class="list-content"><div style="font-weight:bold;">[일머리] 점수 상승!</div><div class="list-sub">방금 전 · 김 대리님 평가</div></div><div style="color:#e74c3c; font-weight:bold;">+10</div></li></ul>
        </div>
        <div id="tab-trophy" class="sub-content">
            <div class="achieve-grid"><div class="achieve-item unlocked" onclick="openSheet('👶', '첫 걸음', '가입을 환영합니다!', '2025.12.05')"><div class="achieve-icon">👶</div><div class="achieve-title">첫 걸음</div></div><div class="achieve-item"><div class="achieve-icon">🔥</div><div class="achieve-title">열정</div></div><div class="achieve-item"><div class="achieve-icon">👑</div><div class="achieve-title">인기인</div></div></div>
        </div>
    </div>

    <div id="screen-vote" class="screen">
        <div style="text-align:center; margin-top:10px;">
            <span class="ticket-badge" id="ticketDisplay">🎫 남은 티켓: 5/5</span>
            <br>
            <span class="round-badge" id="roundBadge">토너먼트 시작</span>
            <h3 id="voteTitle" style="text-align:center; min-height:50px; margin-top:10px;">질문을 불러오는 중...</h3>
        </div>
        <div class="vs-container" id="vsContainer">
            <div class="vs-card" onclick="vote(0)">
                <div class="vs-avatar" id="avatarA">❓</div>
                <div class="vs-text-area"><div class="vs-name" id="nameA">...</div><div class="vs-desc" id="descA">...</div></div>
            </div>
            <div style="text-align:center; font-weight:bold; color:#ccc;">VS</div>
            <div class="vs-card" onclick="vote(1)">
                <div class="vs-avatar" id="avatarB">❓</div>
                <div class="vs-text-area"><div class="vs-name" id="nameB">...</div><div class="vs-desc" id="descB">...</div></div>
            </div>
        </div>
        <div id="winnerContainer" style="display:none; flex:1; flex-direction:column; justify-content:center; align-items:center;">
            <div class="winner-box">
                <div class="winner-avatar" id="winnerAvatar">🏆</div>
                <h2 style="margin-bottom:5px;">우승!</h2>
                <h1 id="winnerName" style="font-size:30px; color:var(--primary);">...</h1>
                <p id="winnerText">이 친구에게 점수가 전달되었습니다.</p>
                <button class="btn btn-primary" onclick="startTournament()">다음 토너먼트 시작하기</button>
            </div>
        </div>
        <button class="btn btn-pass" id="passBtn" onclick="startTournament()">🤔 잘 모르는 사람들이에요 (새로고침)</button>
    </div>

    <div id="screen-rank" class="screen">
        <div class="rank-header-area">
            <h2 style="text-align:center;">친구 랭킹</h2>
            <div class="rank-filter-row"><div class="stat-pills"><div class="stat-pill active" onclick="filterRank(this, -1)">종합</div><div class="stat-pill" onclick="filterRank(this, 0)">일머리</div><div class="stat-pill" onclick="filterRank(this, 1)">유머</div><div class="stat-pill" onclick="filterRank(this, 2)">의리</div><div class="stat-pill" onclick="filterRank(this, 3)">센스</div><div class="stat-pill" onclick="filterRank(this, 4)">매력</div><div class="stat-pill" onclick="filterRank(this, 5)">광기</div></div><div class="more-btn" onclick="openSheet('🏆', '전체 순위', '준비 중')">더 보기 ></div></div>
        </div>
        <ul class="list-wrap" id="rankListContainer"></ul>
        <div id="emptyRankState" class="empty-state">
            <div class="empty-close" onclick="toggleEmptyState()">✕</div>
            <div class="empty-icon">🍃</div><h3 style="margin-bottom:10px;">너무 조용한데요?</h3><p style="margin-bottom:30px;">아직 친구가 없어요.</p><button class="btn btn-primary" style="width:auto; padding:12px 30px;" onclick="alert('링크 복사됨!')">친구 초대하기</button>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <h2 style="text-align:center;">상점</h2>
        <div style="text-align:center; margin-bottom:10px; font-weight:bold; color:var(--primary);">내 보유 토큰: <span id="shopTokenDisplay">0</span> 💎</div>
        
        <div class="shop-section">
            <div class="shop-title">💎 토큰 충전소</div>
            <div class="shop-grid">
                <div class="shop-item" onclick="alert('결제 API 연동 필요!')"><div class="shop-item-img">💰</div><div class="shop-item-name">토큰 100개</div><div class="shop-item-price cash-price">₩ 1,200</div></div>
                <div class="shop-item" onclick="alert('결제 API 연동 필요!')"><div class="shop-item-img">💰</div><div class="shop-item-name">토큰 550개</div><div class="shop-item-price cash-price">₩ 5,900</div></div>
            </div>
        </div>

        <div class="shop-section">
            <div class="shop-title">🦊 아바타 스킨</div>
            <div class="shop-grid">
                <div class="shop-item" onclick="purchaseItem(50, 'Avatar', '🐯')"><div class="shop-item-img">🐯</div><div class="shop-item-name">호랑이</div><div class="shop-item-price">💎 50</div></div>
                <div class="shop-item" onclick="purchaseItem(50, 'Avatar', '🐰')"><div class="shop-item-img">🐰</div><div class="shop-item-name">토끼</div><div class="shop-item-price">💎 50</div></div>
            </div>
        </div>
        
        <div class="shop-section">
            <div class="shop-title">🎒 아이템 상점</div>
            <div class="shop-grid">
                <div class="shop-item" onclick="purchaseItem(100, 'Banner', '응원 배너')"><div class="shop-item-img">📢</div><div class="shop-item-name">응원 배너</div><div class="shop-item-price">💎 100</div></div>
                <div class="shop-item" onclick="purchaseItem(200, 'Skin', '황금 스킨')"><div class="shop-item-img">🎨</div><div class="shop-item-name">황금 스킨</div><div class="shop-item-price">💎 200</div></div>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <h2 style="text-align:center;">설정</h2>
        <div class="settings-profile"><div class="st-avatar">🦊</div><div class="st-info"><div class="st-name">나 (Me)</div><div class="st-account">kakao_u***</div></div></div>
        <div class="settings-msg-box">
            <span class="st-msg-label">나의 한마디</span>
            <div class="st-msg-text" id="settingMsg">"상태 메시지를 입력해주세요"</div>
            <div class="st-msg-edit" onclick="editProfileMsg()">✏️</div>
        </div>
        <ul class="settings-menu">
            <li class="st-menu-item" onclick="alert('구매 기록')"><span>💰 구매 기록</span><span class="st-arrow">></span></li>
            <li class="st-menu-item"><span>🔔 알림 설정</span><span class="st-arrow">></span></li>
            <li class="st-menu-item"><span>📜 이용 약관</span><span class="st-arrow">></span></li>
        </ul>
        <button class="btn" style="background:#eee; color:#ff4757;" onclick="logout()">로그아웃</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="goTab('screen-main', this)"><span class="nav-icon">🪞</span>거울</div>
        <div class="nav-item" onclick="goTab('screen-vote', this)"><span class="nav-icon">⚖️</span>평가</div>
        <div class="nav-item" onclick="goTab('screen-rank', this)"><span class="nav-icon">🏆</span>랭킹</div>
        <div class="nav-item" onclick="goTab('screen-shop', this)"><span class="nav-icon">🛍️</span>상점</div>
        <div class="nav-item" onclick="goTab('screen-settings', this)"><span class="nav-icon">⚙️</span>설정</div>
    </div>

    <div id="bottomSheetOverlay" class="sheet-overlay" onclick="closeSheet()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="sheet-icon" id="sheetIcon">🎁</div><div class="sheet-title" id="sheetTitle">제목</div><div class="sheet-desc" id="sheetDesc">내용</div><div style="font-size:12px; color:#b2bec3; margin-bottom:20px;" id="sheetSub">부가정보</div><button class="btn btn-primary" onclick="closeSheet()">확인</button>
        </div>
    </div>
    <div id="profileSheetOverlay" class="sheet-overlay" onclick="closeSheet()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="profile-header"><div class="profile-avatar" id="pfAvatar">🐶</div><div class="profile-name" id="pfName">이 과장</div><div class="profile-msg" id="pfMsg">"인생은 실전이다"</div></div>
            <div style="background:#f8f9fa; padding:15px; border-radius:12px;"><h4 style="margin:0 0 10px 0; color:#2d3436;">💌 내가 보낸 시그널</h4><ul class="signal-list"><li class="signal-item"><span class="signal-label">일머리 평가</span><span class="signal-val">A (상위 1%)</span></li></ul></div><br><button class="btn btn-primary" onclick="closeSheet()">닫기</button>
        </div>
    </div>
</div>

<script type="module" src="script.js"></script>
</body>
</html>